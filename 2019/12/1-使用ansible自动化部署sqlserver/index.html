<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" 1 使用ansible自动化部署SQLServer &middot;  Pray" />
  	<meta property="og:site_name" content="Pray" />
  	<meta property="og:url" content="http://hliblack.github.io/2019/12/1-%E4%BD%BF%E7%94%A8ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2sqlserver/" />
    
    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2019-12-25T17:37:15&#43;08:00" />

    
    

  <title>
     1 使用ansible自动化部署SQLServer &middot;  Pray
  </title>

    <meta name="description" content="note record" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://hliblack.github.io/images/favicon.ico">
	  <link rel="apple-touch-icon" href="http://hliblack.github.io/images/apple-touch-icon.png" />
    
    <link rel="stylesheet" type="text/css" href="http://hliblack.github.io/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />


    
      
          <link href="http://hliblack.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Pray" />
      
      
    
    <meta name="generator" content="Hugo 0.62.0" />

    <link rel="canonical" href="http://hliblack.github.io/2019/12/1-%E4%BD%BF%E7%94%A8ansible%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2sqlserver/" />

     
</head>
<body class="nav-closed">
<div id="particles-js"></div>
  


 <div class="site-wrapper">



<header class="main-header " style="background-image: url(http://hliblack.github.io/images/user.jpg)">

    <nav class="main-nav overlay clearfix">
        
            <a class="blog-logo" href="http://hliblack.github.io/"><img src="http://hliblack.github.io/images/user.png" alt="Blog Logo" /></a>
        
        
    </nav>
<div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">
              <a class="btn-bootstrap-2" href="#content">Pray</a>
          </h1>
          <h2 class="page-description">note record</h2>
        </div>
</div>
    <a class="scroll-down icon-arrow-left" href="#content"><span class="hidden">Scroll Down</span></a>
</header>

  <main id="content" class="content" role="main">


  <article class="post 2019">

    <header class="post-header">
        <h1 class="post-title">1 使用ansible自动化部署SQLServer</h1>
        <section class="post-meta">
        
         
        </section>
    </header>

    <section class="post-content">
      <h1 id="ansiblesqlserver">使用ansible自动化部署SQLServer</h1>
<h2 id="heading">前提条件</h2>
<ol>
<li>
<p>Windows2008 以下的操作系统需要先升级 Powershell;
远程连接到 Windows 服务器，以管理员权限运行 Powershell，执行以下命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"> $url = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">https://raw.githubusercontent.com/jborean93/ansible-windows/master/scripts/Upgrade-PowerShell.ps1</span><span style="color:#e6db74">&#34;</span>
 $file = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">$</span><span style="color:#e6db74">env:temp\Upgrade-PowerShell.ps1</span><span style="color:#e6db74">&#34;</span>
 $username = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Administrator</span><span style="color:#e6db74">&#34;</span>
 $password = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Password</span><span style="color:#e6db74">&#34;</span>
        
 (New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)
 Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
        
 <span style="color:#75715e"># Version can be 3.0, 4.0 or 5.1</span>
 &amp;$file -Version 5.1 -Username $username -Password $password -Verbose
</code></pre></div></li>
<li>
<p>完成升级后，还需要删除自动登录并将执行策略设置回默认值 Restricted：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"> <span style="color:#75715e"># This isn&#39;t needed but is a good security practice to complete</span>
 Set-ExecutionPolicy -ExecutionPolicy Restricted -Force

 $reg_winlogon_path = <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon</span><span style="color:#e6db74">&#34;</span>
 Set-ItemProperty -Path $reg_winlogon_path -Name AutoAdminLogon -Value 0
 Remove-ItemProperty -Path $reg_winlogon_path -Name DefaultUserName -ErrorAction SilentlyContinue
 Remove-ItemProperty -Path $reg_winlogon_path -Name DefaultPassword -ErrorAction SilentlyContinue
</code></pre></div></li>
<li>
<p>WinRM 设置，在受控端使用 powershell 运行以下命令：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> <span style="color:#75715e"># This isn&#39;t needed but is a good security practice to complete</span>
 Set-ExecutionPolicy -ExecutionPolicy Restricted -Force

 $reg_winlogon_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;HKLM:\Software\Microsoft\Windows NT\CurrentVersion\Winlogon&#34;</span>
 Set-ItemProperty -Path $reg_winlogon_path -Name AutoAdminLogon -Value <span style="color:#ae81ff">0</span>
 Remove-ItemProperty -Path $reg_winlogon_path -Name DefaultUserName -ErrorAction SilentlyContinue
 Remove-ItemProperty -Path $reg_winlogon_path -Name DefaultPassword -ErrorAction SilentlyContinue
</code></pre></div><p>然后再执行：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">set winrm/config/service <span style="color:#e6db74">&#39;@{AllowUnencrypted
</span><span style="color:#e6db74">winrm set winrm/config/service/auth &#39;</span>@{Basic=<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">true</span><span style="color:#e6db74">&#34;</span>}<span style="color:#960050;background-color:#1e0010">&#39;</span>
</code></pre></div></li>
<li>
<p>在防火墙开放5985端口重新连接。</p>
</li>
</ol>
<h2 id="heading-1">主控端设置</h2>
<p>在 ansible 已安装的前提下，还需要安装 winrm 模块：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">apt-get install libkrb5-dev
pip install paramiko PyYAML Jinja2 httplib2 six 
</code></pre></div><p>hosts 文件示例：</p>
<blockquote>
<p>[windows-server]
40.121.233.233
[windows-server:vars]
ansible_ssh_user=”admin”
ansible_ssh_pass=”123456”
ansible_ssh_port=5985
ansible_connection=”winrm”
ansible_winrm_server_cert_validation=ignore</p>
</blockquote>
<h2 id="heading-2">正式安装</h2>
<ol>
<li>安装SQLServer运行所需要的组件，如：vc++运行库，jdk等；</li>
<li>根据微软官方文档生成安装配置文件
<ul>
<li>下载解压安装包</li>
</ul>
</li>
</ol>
<ul>
<li>在 cmd 中运行 SETUP.exe /UIMODE=Normal /ACTION=INSTALL</li>
<li>得到安装配置文件后，修改：
<ul>
<li>注释 UIMode</li>
<li>增加 IACCEPTSQLSERVERLICENSETERMS=”True”</li>
<li>增加 SAPWD=”websoft9!”</li>
<li>将 QUIET=”False” 改为 QUIET=”True”</li>
</ul>
</li>
</ul>
<ol start="3">
<li>编写 ansible 脚本
脚本已上传 github ，链接为：https://github.com/Websoft9/ansible-sqlserver.git</li>
</ol>

    </section>


  <footer class="post-footer">


    
    <figure class="author-image">

        <a class="img" href="http://hliblack.github.io/" style="background-image: url(http://hliblack.github.io/images/user.png)"><span class="hidden">hliblack</span></a>
    </figure>
    

    <section class="author">

  <p>hliblack</p>
  

</section>


    
    <section class="share">
      <h4>Share this 2019</h4>
      <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=1%20%e4%bd%bf%e7%94%a8ansible%e8%87%aa%e5%8a%a8%e5%8c%96%e9%83%a8%e7%bd%b2SQLServer&amp;url=http%3a%2f%2fhliblack.github.io%2f2019%2f12%2f1-%25E4%25BD%25BF%25E7%2594%25A8ansible%25E8%2587%25AA%25E5%258A%25A8%25E5%258C%2596%25E9%2583%25A8%25E7%25BD%25B2sqlserver%2f"
          onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <span class="hidden">Twitter</span>
      </a>
      <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fhliblack.github.io%2f2019%2f12%2f1-%25E4%25BD%25BF%25E7%2594%25A8ansible%25E8%2587%25AA%25E5%258A%25A8%25E5%258C%2596%25E9%2583%25A8%25E7%25BD%25B2sqlserver%2f"
          onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <span class="hidden">Facebook</span>
      </a>
      <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=http%3a%2f%2fhliblack.github.io%2f2019%2f12%2f1-%25E4%25BD%25BF%25E7%2594%25A8ansible%25E8%2587%25AA%25E5%258A%25A8%25E5%258C%2596%25E9%2583%25A8%25E7%25BD%25B2sqlserver%2f"
         onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
          <span class="hidden">Google+</span>
      </a>
    </section>
    

    
    
    

  </footer>
</article>

</main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="">Pray</a> </section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="https://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/syui/hugo-theme-air">hugo-theme-air</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="http://hliblack.github.io/js/jquery.js"></script>
    <script type="text/javascript" src="http://hliblack.github.io/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://hliblack.github.io/js/index.js"></script>
    <script src="http://hliblack.github.io/js/particles.min.js"></script>
    <script src="http://hliblack.github.io/js/particles.js"></script>  

</body>
</html>

